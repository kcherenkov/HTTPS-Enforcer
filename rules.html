<!doctype html>
<html>
<head>
    <title id="rulesTitle"></title>
    <link href="css/main.css" rel="stylesheet"/>
    <link rel="stylesheet" href="css/demo_table.css"/>
    <style type="text/css">
        td.enabled, td.details {
            cursor: pointer;
            text-align: center;
        }

        td.more {
            margin: 20px;
        }

        td.more h3 {
            margin: 0 10px 0 0;
        }
    </style>
    <script src="scripts/jquery-1.6.4.min.js"></script>
    <script src="scripts/jquery.dataTables.min.js"></script>
    <script>
        const checkmark = '\u2714';
        const ballotx = '\u2718';
        const circledplus = '\u2295';
        const circledminus = '\u2296';
    </script>
    <script>
        var db = chrome.extension.getBackgroundPage().db;
        var rulesNameL = chrome.i18n.getMessage("rulesName");
        var rulesStatusL = chrome.i18n.getMessage("rulesStatus");
        db.readTransaction(function(tx) {
            tx.executeSql('SELECT * FROM "rulesets"', [],
                    function(tx, resultSet) {
                        var data = [];
                        for (var i = 0, l = resultSet.rows.length; i < l; ++i) {
                            data.push(
                                    {   0: circledplus,
                                        1: resultSet.rows.item(i)['name'],
                                        2: resultSet.rows.item(i)['enabled'],
                                        DT_RowId: resultSet.rows.item(i)['id']
                                    });
                        }
                        $(function() {
                            var lang = navigator.language === "ru"?{"sUrl": "scripts/dataTables.russian.json"}:{};
                            var oTable = $('#rulesets').dataTable({
                                "aaData": data,
                                "oLanguage": lang,
                                "aoColumns": [
                                    {   "sTitle": "",
                                        "bSearchable": false,
                                        "bSortable": false,
                                        "sClass": "details"
                                    },
                                    { "sTitle": rulesNameL },
                                    { "sTitle": rulesStatusL,
                                        "bSearchable": false,
                                        "sClass" : "enabled",
                                        "fnRender": function(obj) {
                                            var sReturn = obj.aData[ obj.iDataColumn ];
                                            if (sReturn === "true")
                                                sReturn = checkmark;
                                            else if (sReturn === "false")
                                                sReturn = ballotx;
                                            return sReturn;
                                        }
                                    }

                                ],
                                "sPaginationType": "full_numbers"
                            });

                            $('td.details').live('click', function() {
                                var nTr = this.parentNode;
                                var id = this.parentNode.id;
                                if (this.innerText === circledminus) {
                                    /* This row is already open - close it */
                                    this.innerText = circledplus;
                                    oTable.fnClose(nTr);
                                }
                                else {
                                    /* Open this row */
                                    this.innerText = circledminus;
                                    oTable.fnOpen(nTr, fnFormatDetails(oTable, nTr), 'more');
                                    renderTables();
                                }
                                /* Formating function for row details */
                                function fnFormatDetails(oTable, nTr) {
                                    var sOut = '';
                                    sOut += '<h3>Hosts</h3>';
                                    sOut += '<table class="hostsTable" class="display"></table>';
                                    sOut += '<br />';
                                    sOut += '<h3>Rules</h3>';
                                    sOut += '<table class="rulesTable" class="display"></table>';
                                    sOut += '<br />';
                                    sOut += '<h3>Exclusions</h3>';
                                    sOut += '<table class="exclusionsTable" class="display"></table>';
                                    sOut += '<br />';
                                    sOut += '<h3>Cookies</h3>';
                                    sOut += '<table class="cookiesTable" class="display"></table>';
                                    return sOut;
                                }

                                function renderTables() {
                                    db.readTransaction(function(tx) {
                                        renderTable(tx, "hosts", id, ['host']);
                                        renderTable(tx, "exclusions", id, ['pattern']);
                                        renderTable(tx, "rules", id, ['from', 'to']);
                                        renderTable(tx, "cookies", id, ['host', 'name']);
                                    });

                                    function renderTable(tx, table, ruleset_id, columns) {
                                        tx.executeSql('SELECT * FROM "' + table + '" WHERE "ruleset_id" = ?', [ruleset_id],
                                                function(tx, resultSet) {
                                                    var data = [];

                                                    for (var i = 0, l = resultSet.rows.length; i < l; ++i) {
                                                        var item = [];
                                                        for (var j = 0, lj = columns.length; j < lj; ++j) {
                                                            item.push(resultSet.rows.item(i)[columns[j]]);
                                                        }
                                                        data.push(item);
                                                    }
                                                    var aoColumns = [];
                                                    for (i = 0,l = columns.length; i < l; ++i)
                                                        aoColumns.push({ "sTitle": columns[i] });
                                                    $(nTr).next().find('.' + table + 'Table').dataTable({
                                                        "aaData": data,
                                                        "aoColumns": aoColumns,
                                                        "sDom": 't'
                                                    });

                                                }
                                        );
                                    }
                                }

                            });
                        });
                    });
        });
    </script>
    <script>
        $(function() {
            $('td.enabled').live('click', function() {
                var id = this.parentNode.id;
                var td = this;
                var isEnabled;

                if (this.innerText === checkmark)
                    isEnabled = true;
                else if (this.innerText === ballotx)
                    isEnabled = false;
                db.transaction(function(tx) {
                    tx.executeSql('UPDATE "rulesets" SET "enabled" = ? WHERE "id" = ?', [!isEnabled, id],
                            function(tx, resultSet) {
                                td.innerHTML = isEnabled ? ballotx : checkmark;
                            });
                });
            });

            document.getElementById('rulesTitle').innerText = chrome.i18n.getMessage("rulesTitle");
            document.getElementById('rulesHeader').innerText = chrome.i18n.getMessage("rulesHeader");
        });
    </script>

</head>
<body>
<header><h1 id="rulesHeader"></h1></header>
<table id="rulesets" class="display">
</table>
</body>
</html>