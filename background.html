<script>
chrome.extension.getManifest = (function(callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'manifest.json', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            var manifest = JSON.parse(xhr.responseText);
            callback(manifest);
        }
    };
    xhr.send();
});

var version = localStorage['version'];

var db = openDatabase('https_everywhere', "1.0", 'HTTPS Enforcer data', 5 * 1024 * 1024, function(database) {
    createAndPopulateDatabase();
});

chrome.extension.getManifest(function(manifest) {
    localStorage['version'] = manifest.version;
    if (version != manifest.version)
    {
        if ('undefined' === typeof version) // first start
        {
            localStorage['protectsCount'] = 0;
            localStorage['enableXhr'] = false;
            localStorage['sendNewSite'] = false;
            localStorage['secureCookies'] = true;
            localStorage['checkBeforeRedirect'] = false;
        }
        else    // update
        {
            updateDatabase(function(success) {
            });
        }
    }
});

var tabs = [];
var a = document.createElement('a');    //global a element for retrieve parts of url, i.e. host, protocol, etc

chrome.tabs.onRemoved.addListener(function(tabId, removeInfo) {
    delete tabs[tabId];
});

const green = [150, 230, 120, 250];
const red = [230, 150, 120, 250];
const yellow = [230, 230, 120, 250];

function disableRuleset(ruleset_id, host) {
    db.transaction(function(tx) {
        tx.executeSql('UPDATE "rulesets" SET "enabled" = ? WHERE "id" = ?', [false, ruleset_id]);
    });

    if (localStorage['sendNewSite'] === 'true') {
        reportSite(host, 'del');
    }
}

chrome.extension.onRequest.addListener(
        function(request, sender, sendResponse) {
            if (request.disableRuleset) {
                disableRuleset(request.ruleset_id, tabs[sender.tab.id].host);
                delete tabs[sender.tab.id].host;
            }
            sendResponse({}); // snub them.
        });

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    if (tab.url.substr(0, 4) !== 'http' || changeInfo.status !== 'loading')
        return;

    if ('undefined' === typeof tabs[tabId])
        tabs[tabId] = new Object();

    a.href = tab.url;
    var host = a.hostname;
    var protocol = a.protocol;

    // hack because XMLHttpRequest cannot catch redirect headers (it internally follows redirects
    // and returns status code 200). Sometimes it leads to infinity refreshing page.
    // See https://w3.org as example.
    if ('undefined' !== typeof tabs[tabId].ruleset_id) {
        if ('undefined' === typeof changeInfo.url) {    //that means infinity refreshing page
            disableRuleset(tabs[tabId].ruleset_id, tabs[tabId].host);
            delete tabs[tabId].ruleset_id;
            delete tabs[tabId].host;
            tabs[tabId].wasRedirected = false;
        }
        else if (!tabs[tabId].wasRedirected) {
            chrome.tabs.insertCSS(tabId, {file: 'css/notification.css'}, function() {
                chrome.tabs.executeScript(tabId, {code: 'var backUrl = "' + tabs[tabId].backUrl + '"; var ruleset_id="' + tabs[tabId].ruleset_id + '";'}, function() {
                    chrome.tabs.executeScript(tabId, {file: 'scripts/notification.js'}, function() {
                        delete tabs[tabId].ruleset_id;
                    });
                });
            });
        }
        else {
            delete tabs[tabId].ruleset_id;
            tabs[tabId].wasRedirected = false;
        }
    }

    if ('undefined' !== typeof tabs[tabId].host) {
        if (tabs[tabId].host === host && protocol === 'https:') { //site already under protection
            setBadge(tabId, green);
            return;
        }
        else {
            delete tabs[tabId].host;
            delete tabs[tabId].possible_ruleset_ids;
        }
    }
    else
        delete tabs[tabId].possible_ruleset_ids;

    db.readTransaction(function(tx) {
        tx.executeSql('SELECT DISTINCT "ruleset_id" FROM "hosts" WHERE ? LIKE ("host")', [host],
                function(tx, resultSet) {
                    var rowsCount = resultSet.rows.length;
                    if (rowsCount < 1) {
                        //There are no rules for that host in our database, so try to ping secure version of that site
                        if (localStorage['enableXhr'] === 'true' && protocol === 'http:') {    //http only
                            tabs[tabId].backUrl = tab.url;
                            tryFindSecureSite(tab.url, tabId);
                        }
                        return;
                    }
                    var ruleset_ids = [];
                    for (var i = 0; i < rowsCount; ++i) {
                        ruleset_ids.push(resultSet.rows.item(i)['ruleset_id']);
                    }

                    tabs[tabId].possible_ruleset_ids = ruleset_ids;
                    var q = '?';
                    for (i = 1; i < rowsCount; ++i)
                        q += ', ?';
                    tx.executeSql('SELECT "id" FROM "rulesets" WHERE "enabled" = "true" AND "id" IN (' + q + ')', ruleset_ids,
                            function(tx, resultSet) {
                                var rowsCount = resultSet.rows.length;
                                if (rowsCount < 1) {    //That means all rules are disabled
                                    setBadge(tabId, red);
                                    return;
                                }
                                var ruleset_ids = [];
                                for (var i = 0; i < rowsCount; ++i) {
                                    ruleset_ids.push(resultSet.rows.item(i)['id']);
                                }
                                var q = '?';
                                for (i = 1; i < rowsCount; ++i)
                                    q += ', ?';
                                tx.executeSql('SELECT "pattern" FROM "exclusions" WHERE "ruleset_id" IN (' + q + ')', ruleset_ids,
                                        function(tx, resultSet) {
                                            for (var i = 0, l = resultSet.rows.length; i < l; ++i) {
                                                if (new RegExp(resultSet.rows.item(i)['pattern']).test(tab.url)) {
                                                    setBadge(tabId, yellow);
                                                    return;
                                                }
                                            }
                                            tx.executeSql('SELECT "from", "to", "ruleset_id" FROM "rules" WHERE "ruleset_id" IN (' + q + ')', ruleset_ids,
                                                    function(tx, resultSet) {
                                                        for (var i = 0, l = resultSet.rows.length; i < l; ++i) {
                                                            var fromRegExp = new RegExp(resultSet.rows.item(i)['from']);
                                                            if (fromRegExp.test(tab.url)) {
                                                                var newUrl = tab.url.replace(
                                                                        fromRegExp,
                                                                        resultSet.rows.item(i)['to']
                                                                );
                                                                if (localStorage['checkBeforeRedirect'] === 'true') {
                                                                    checkUrl(newUrl, function(isAvailable) {
                                                                        if (isAvailable) {
                                                                            redirect(tabId, newUrl);
                                                                            tabs[tabId].ruleset_id = resultSet.rows.item(i)['ruleset_id'];
                                                                            tabs[tabId].wasRedirected = true;
                                                                        }
                                                                    });
                                                                }
                                                                else {
                                                                    redirect(tabId, newUrl);
                                                                    tabs[tabId].ruleset_id = resultSet.rows.item(i)['ruleset_id'];
                                                                    tabs[tabId].wasRedirected = true;
                                                                }
                                                                return;
                                                            }
                                                        }
                                                        setBadge(tabId, yellow);  //There is rules for host, but regexps don`t match
                                                    });
                                        });
                            });
                });
    });
});

function setBadge(tabId, color) {
    chrome.browserAction.setBadgeBackgroundColor({color: color, tabId: tabId});
    chrome.browserAction.setBadgeText({text: ' ', tabId: tabId});
}

function redirect(tabId, newUrl, insertIntoDb) {
    chrome.tabs.executeScript(tabId,
            {code: 'window.location.href!=="' + newUrl + '" && window.location.replace("' + newUrl + '")'});

    localStorage['protectsCount'] = parseInt(localStorage['protectsCount']) + 1;


    var newHost = newUrl.slice(8, newUrl.indexOf('/', 8));
    tabs[tabId].host = newHost;
    var wasWithWww = false;
    if (newHost.substr(0, 3) === 'www') {
        newHost = newHost.substr(4);
        wasWithWww = true;
    }
    if (insertIntoDb) {
        db.transaction(function(tx) {
            tx.executeSql('INSERT INTO "rulesets" ("name") VALUES (?)', [newHost],
                    function(tx, resultSet) {
                        tx.executeSql('INSERT INTO "hosts" ("host", "ruleset_id") VALUES (?, ?)',
                                [newHost, resultSet.insertId]);
                        tx.executeSql('INSERT INTO "hosts" ("host", "ruleset_id") VALUES (?, ?)',
                                ['www.' + newHost, resultSet.insertId]);
                        tx.executeSql('INSERT INTO "rules" ("from", "to", "ruleset_id") VALUES (?, ?, ?)',
                                ['^http://(www\\.)?' + newHost.replace('.', '\\.') + '/', 'https://' + (wasWithWww ? 'www.' + newHost : newHost) + '/', resultSet.insertId]);

                        tabs[tabId].ruleset_id = resultSet.insertId;
                        tabs[tabId].possible_ruleset_ids = [resultSet.insertId];
                    })
        });

        if (localStorage['sendNewSite'] === 'true') {
            reportSite(newHost, 'add');
        }
    }
}

function reportSite(host, action) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'http://securegoogle.net/https-everywhere.njs?action=' + action, true);
    xhr.send(host);
}

function updateDatabase(callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'drop.sql', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            var queries = xhr.responseText.split(';');
            db.transaction(function(tx) {
                        for (var key in queries)
                            tx.executeSql(queries[key]);
                    }, function() {
                        callback(false);
                    },
                    function() {
                        populateDatabase();
                        callback(true);
                    });
        }
    };
    xhr.send();
}

function checkUrl(newUrl, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('HEAD', newUrl, true);
    var wasRedirected = false;
    xhr.onreadystatechange = function() {
        if (this.readyState === 4 && this.status === 200) {
            if (wasRedirected) {
                callback(false);
                return;
            }
            callback(true);
        }
        else if (this.readyState === 4 && this.status === 0) {
            callback(false);
        }
        else if (this.readyState === 3 && this.status === 200) {
            //There was 301, 302 or 303 redirect! Can`t catch 307 redirect :(
            wasRedirected = true;
            this.abort();
        }
    };
    xhr.send();
}

function tryFindSecureSite(url, tabId) {
    var newUrl = url.replace('http', 'https');
    checkUrl(newUrl, function(found) {
        if (found) {
            redirect(tabId, newUrl, true);
        }
        else {
            newUrl = newUrl.substr(7, 3) === 'www' ? 'https://' + newUrl.substr(11) : newUrl.replace('https://', 'https://www.');
            checkUrl(newUrl, function(found) {
                if (found) {
                    redirect(tabId, newUrl, true);
                }
            })
        }
    });
}

function createAndPopulateDatabase() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'create.sql', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            var queries = xhr.responseText.split(';');
            db.transaction(function(tx) {
                for (var key in queries)
                    tx.executeSql(queries[key]);
            }, null, function() {
                populateDatabase();
            });
        }
    };
    xhr.send();
}

function populateDatabase(successCallback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'db.xml', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            var xml = xhr.responseXML;
            var rulesets = xml.getElementsByTagName('ruleset');

            db.transaction(function(tx) {
                for (var i = 0, l = rulesets.length; i < l; ++i) {
                    var ruleset = rulesets[i];
                    tx.executeSql('INSERT INTO "rulesets"("name", "enabled") VALUES(?, ?)',
                            [ruleset.getAttribute('name'), !ruleset.hasAttribute('default_off')],
                            function(tx, resultSet) {
                                var ruleset = rulesets[resultSet.insertId - 1];

                                var hosts = ruleset.getElementsByTagName('target');
                                for (i = 0,l = hosts.length; i < l; ++i) {
                                    var host = hosts[i];
                                    tx.executeSql('INSERT INTO "hosts"("host", "ruleset_id") VALUES(?, ?)',
                                            [host.getAttribute('host'), resultSet.insertId]);
                                }


                                var rules = ruleset.getElementsByTagName('rule');
                                for (i = 0,l = rules.length; i < l; ++i) {
                                    var rule = rules[i];
                                    tx.executeSql('INSERT INTO "rules"("from", "to", "ruleset_id") VALUES(?, ?, ?)',
                                            [rule.getAttribute('from'), rule.getAttribute('to'), resultSet.insertId]);
                                }

                                var cookies = ruleset.getElementsByTagName('securecookie');
                                for (i = 0,l = cookies.length; i < l; ++i) {
                                    var cookie = cookies[i];
                                    tx.executeSql('INSERT INTO "cookies"("host", "name", "ruleset_id") VALUES(?, ?, ?)',
                                            [cookie.getAttribute('host'), cookie.getAttribute('name'), resultSet.insertId]);
                                }

                                var exclusions = ruleset.getElementsByTagName('exclusion');
                                for (var i = 0, l = exclusions.length; i < l; ++i) {
                                    var exclusion = exclusions[i];
                                    tx.executeSql('INSERT INTO "exclusions"("pattern", "ruleset_id") VALUES(?, ?)',
                                            [exclusion.getAttribute('pattern'), resultSet.insertId]);
                                }
                            }
                    );
                }
            }, null, function() {
                db.transaction(function(tx) {
                    tx.executeSql('UPDATE "hosts" SET "host" = REPLACE ("host", "*", "%")');    //for LIKE statements
                }, null, function() {
                    if ('undefined' !== typeof successCallback)
                    {
                        //  When you are entering data into a new table which has indexes on it,
                        //  this can be much slower than entering all the data first, and then creating the index.
                        db.transaction(function(tx) {
                            var tableNames = ['hosts', 'rules', 'cookies', 'exclusions'];
                            for (var key in tableNames)
                                tx.executeSql('CREATE INDEX "' + tableNames[key] + '_ruleset_id_index" ON "' + tableNames[key] + '" ("ruleset_id")');
                            tx.executeSql('CREATE INDEX "hosts_host_index" ON "hosts" ("host")');
                        });
                        successCallback();
                    }
                }, function(error){
                    console.log(error);
                });
            });
        }
    };
    xhr.send();
}

//secure cookies
chrome.cookies.onChanged.addListener(function(changeInfo) {
    if (localStorage['secureCookies'] === 'true' && !changeInfo.cookie.removed && !changeInfo.cookie.secure) {
        db.readTransaction(function(tx) {
            tx.executeSql('SELECT COUNT(*) AS c FROM "hosts" JOIN "rulesets" ON ("rulesets"."id"="hosts"."ruleset_id") JOIN "cookies" ON ("hosts"."ruleset_id"="cookies"."ruleset_id") WHERE "rulesets"."enabled"="true" AND ? LIKE ("hosts"."host") AND ? REGEXP("cookies"."host") AND ? REGEXP ("cookies"."name")', [changeInfo.cookie.domain, changeInfo.cookie.domain, changeInfo.cookie.name],
                    function(tx, resultSet) {
                        if (resultSet.rows.item(0)['c'] > 0)
                            chrome.cookies.set(
                                    {
                                        url: 'https://' + changeInfo.cookie.domain.trim('.'),
                                        name: changeInfo.cookie.name,
                                        value: changeInfo.cookie.value,
                                        domain: changeInfo.cookie.domain,
                                        path: changeInfo.cookie.path,
                                        secure: true,
                                        httpOnly: changeInfo.cookie.httpOnly,
                                        expirationDate: changeInfo.cookie.expirationDate,
                                        storeId: changeInfo.cookie.storeId
                                    }
                            );
                    });
        });
    }
});

</script>
